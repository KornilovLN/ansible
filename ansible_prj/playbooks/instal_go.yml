---
- name: Install Go development environment
  hosts: userver
  become: yes
  vars:
    go_version: "1.23.3"  # Последняя стабильная версия на момент написания
    go_install_dir: "/usr/local/go"
    go_user: "{{ ansible_user }}"
    go_path: "/home/{{ ansible_user }}/go"
    go_proxy: "https://proxy.golang.org,direct"

  tasks:
    # 1. Обновление системы
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    # 2. Установка базовых зависимостей для Go
    - name: Install basic build dependencies
      apt:
        name:
          - curl
          - wget
          - git
          - make
          - gcc
          - g++
          - build-essential
          - libc6-dev
          - pkg-config
          - cmake
          - autoconf
          - automake
          - libtool
          - ca-certificates
          - software-properties-common
          - ssh
          - unzip
          - tree
          - htop
          - ncdu
        state: present
      tags: [dependencies]

    # 3. Загрузка и установка Go
    - name: Check if Go is already installed
      command: "{{ go_install_dir }}/bin/go version"
      register: go_current_version
      ignore_errors: yes
      changed_when: false

    - name: Download Go
      get_url:
        url: "https://go.dev/dl/go{{ go_version }}.linux-amd64.tar.gz"
        dest: "/tmp/go{{ go_version }}.linux-amd64.tar.gz"
        checksum: "sha256:6a5ef1b5e4c63664c68a5888ea2c6d2c30de62aead8acf6f7bb68e3e3bd5f5f6"  # Обновите для вашей версии!
        timeout: 60
      when: >
        go_current_version is failed or
        go_version not in go_current_version.stdout
      tags: [go]

    - name: Remove old Go installation if exists
      file:
        path: "{{ go_install_dir }}"
        state: absent
      when: >
        go_current_version is failed or
        go_version not in go_current_version.stdout
      tags: [go]

    - name: Extract Go
      unarchive:
        src: "/tmp/go{{ go_version }}.linux-amd64.tar.gz"
        dest: "/usr/local"
        remote_src: yes
        owner: root
        group: root
      when: >
        go_current_version is failed or
        go_version not in go_current_version.stdout
      tags: [go]

    # 4. Настройка переменных окружения
    - name: Create GOPATH directory
      file:
        path: "{{ go_path }}"
        state: directory
        owner: "{{ go_user }}"
        group: "{{ go_user }}"
        mode: '0755'
      tags: [environment]

    - name: Create Go workspace directories
      file:
        path: "{{ go_path }}/{{ item }}"
        state: directory
        owner: "{{ go_user }}"
        group: "{{ go_user }}"
        mode: '0755'
      loop:
        - src
        - pkg
        - bin
      tags: [environment]

    - name: Configure environment variables for all users
      lineinfile:
        path: /etc/environment
        regexp: "^GO{{ item.name }}="
        line: "GO{{ item.name }}={{ item.value }}"
        state: present
      loop:
        - { name: "ROOT", value: "{{ go_install_dir }}" }
        - { name: "PATH", value: "{{ go_install_dir }}/bin:$PATH" }
      tags: [environment]

    - name: Add Go to PATH in profile.d
      copy:
        dest: /etc/profile.d/go.sh
        content: |
          # Go environment
          export GOROOT={{ go_install_dir }}
          export GOPATH={{ go_path }}
          export GOPROXY={{ go_proxy }}
          export GOMODCACHE={{ go_path }}/pkg/mod
          export PATH=$PATH:{{ go_install_dir }}/bin:{{ go_path }}/bin
          export GO111MODULE=auto
        mode: '0644'
      tags: [environment]

    - name: Configure user's shell rc files
      block:
        - name: Add Go config to bashrc
          blockinfile:
            path: "/home/{{ go_user }}/.bashrc"
            marker: "# {mark} ANSIBLE MANAGED GO CONFIG"
            block: |
              # Go environment
              export GOROOT={{ go_install_dir }}
              export GOPATH={{ go_path }}
              export GOPROXY={{ go_proxy }}
              export PATH=$PATH:{{ go_install_dir }}/bin:{{ go_path }}/bin
              alias gocd='cd $GOPATH/src'
              alias gob='go build'
              alias gor='go run'
              alias got='go test'
              alias gov='go version'
              alias gomt='go mod tidy'
              alias gofmt='go fmt ./...'

        - name: Add Go config to zshrc (if exists)
          blockinfile:
            path: "/home/{{ go_user }}/.zshrc"
            marker: "# {mark} ANSIBLE MANAGED GO CONFIG"
            block: |
              # Go environment
              export GOROOT={{ go_install_dir }}
              export GOPATH={{ go_path }}
              export GOPROXY={{ go_proxy }}
              export PATH=$PATH:{{ go_install_dir }}/bin:{{ go_path }}/bin
              alias gocd='cd $GOPATH/src'
              alias gob='go build'
              alias gor='go run'
              alias got='go test'
              alias gov='go version'
              alias gomt='go mod tidy'
              alias gofmt='go fmt ./...'
            create: yes
      tags: [environment]

    # 5. Установка популярных Go инструментов
    - name: Install essential Go tools
      become: yes
      become_user: "{{ go_user }}"
      environment:
        GOPATH: "{{ go_path }}"
        GOBIN: "{{ go_path }}/bin"
        PATH: "{{ ansible_env.PATH }}:{{ go_install_dir }}/bin"
      vars:
        go_tools:
          - name: "gopls"
            pkg: "golang.org/x/tools/gopls@latest"
            desc: "Go language server"
          
          - name: "staticcheck"
            pkg: "honnef.co/go/tools/cmd/staticcheck@latest"
            desc: "Static analysis"
          
          - name: "delve"
            pkg: "github.com/go-delve/delve/cmd/dlv@latest"
            desc: "Debugger"
          
          - name: "golint"
            pkg: "golang.org/x/lint/golint@latest"
            desc: "Linter"
          
          - name: "godoc"
            pkg: "golang.org/x/tools/cmd/godoc@latest"
            desc: "Documentation"
          
          - name: "gofumpt"
            pkg: "mvdan.cc/gofumpt@latest"
            desc: "Formatter"
          
          - name: "golangci-lint"
            pkg: "github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
            desc: "Linter aggregator"
          
          - name: "air"
            pkg: "github.com/cosmtrek/air@latest"
            desc: "Live reload"
          
          - name: "mockgen"
            pkg: "go.uber.org/mock/mockgen@latest"
            desc: "Mock generator"
          
          - name: "goimports"
            pkg: "golang.org/x/tools/cmd/goimports@latest"
            desc: "Import formatter"
      tasks:
        - name: Install Go tool {{ item.name }} - {{ item.desc }}
          command: "go install {{ item.pkg }}"
          args:
            creates: "{{ go_path }}/bin/{{ item.name }}"
          loop: "{{ go_tools }}"
          loop_control:
            label: "{{ item.name }}"
      tags: [tools]

    # 6. Установка дополнительных утилит для разработки
    - name: Install development tools
      apt:
        name:
          - sqlite3
          - postgresql-client
          - mysql-client
          - redis-tools
          - ngrok
          - jq
          - yq
          - protobuf-compiler
          - libprotobuf-dev
          - grpc-tools
          - nodejs
          - npm
          - docker-compose
          - kubectl
          - helm
          - stern
          - k9s
        state: present
      tags: [dev-tools]

    # 7. Настройка Git для Go разработки
    - name: Configure Git for Go development
      become: yes
      become_user: "{{ go_user }}"
      block:
        - name: Set Git username
          git_config:
            name: user.name
            scope: global
            value: "{{ go_user }}"

        - name: Set Git email
          git_config:
            name: user.email
            scope: global
            value: "{{ go_user }}@localhost"

        - name: Configure Git for Go modules
          git_config:
            name: "{{ item.name }}"
            scope: global
            value: "{{ item.value }}"
          loop:
            - { name: "pull.rebase", value: "true" }
            - { name: "rebase.autoStash", value: "true" }
            - { name: "core.autocrlf", value: "input" }
            - { name: "core.eol", value: "lf" }
      tags: [git]

    # 8. Создание тестового проекта для проверки
    - name: Create test Go project
      become: yes
      become_user: "{{ go_user }}"
      block:
        - name: Create test project directory
          file:
            path: "{{ go_path }}/src/testproject"
            state: directory
            mode: '0755'

        - name: Create go.mod file
          copy:
            dest: "{{ go_path }}/src/testproject/go.mod"
            content: |
              module testproject

              go {{ go_version }}

        - name: Create main.go file
          copy:
            dest: "{{ go_path }}/src/testproject/main.go"
            content: |
              package main

              import (
                  "fmt"
                  "runtime"
              )

              func main() {
                  fmt.Printf("Go version: %s\n", runtime.Version())
                  fmt.Printf("GOOS: %s\n", runtime.GOOS)
                  fmt.Printf("GOARCH: %s\n", runtime.GOARCH)
                  fmt.Printf("GOROOT: %s\n", runtime.GOROOT())
                  fmt.Println("Go installation successful!")
              }
            mode: '0644'

        - name: Build test project
          command: "go build -o {{ go_path }}/src/testproject/testapp {{ go_path }}/src/testproject/main.go"
          args:
            chdir: "{{ go_path }}/src/testproject"
            creates: "{{ go_path }}/src/testproject/testapp"
          environment:
            GOPATH: "{{ go_path }}"
            PATH: "{{ ansible_env.PATH }}:{{ go_install_dir }}/bin"
      tags: [test]
      when: false  # Установите в true для создания тестового проекта

    # 9. Проверка установки
    - name: Verify Go installation
      command: "{{ go_install_dir }}/bin/go version"
      register: go_version_check
      changed_when: false

    - name: Check Go environment
      shell: |
        echo "GOROOT: $GOROOT"
        echo "GOPATH: $GOPATH"
        echo "GOBIN: $GOBIN"
      environment:
        GOROOT: "{{ go_install_dir }}"
        GOPATH: "{{ go_path }}"
      register: go_env_check
      changed_when: false

    - name: List installed Go tools
      command: "ls -la {{ go_path }}/bin/"
      register: go_tools_list
      changed_when: false

    # 10. Финальный вывод
    - name: Show installation summary
      debug:
        msg: |
          === GO DEVELOPMENT ENVIRONMENT INSTALLED ===
          
          Go Version: {{ go_version_check.stdout }}
          
          Directories:
            GOROOT: {{ go_install_dir }}
            GOPATH: {{ go_path }}
            User: {{ go_user }}
          
          Environment:
            {{ go_env_check.stdout_lines | join('\n            ') }}
          
          Installed tools ({{ go_tools_list.stdout_lines | length - 1 }}):
            {{ go_tools_list.stdout_lines[3:] | join('\n            ') }}
          
          Next steps:
            1. Logout and login again or run: source /etc/profile
            2. Verify: go version
            3. Create new project: mkdir -p $GOPATH/src/myproject
            4. Initialize: cd $GOPATH/src/myproject && go mod init myproject
          
          Configuration files updated:
            - /etc/environment
            - /etc/profile.d/go.sh
            - ~/.bashrc
            - ~/.zshrc (if exists)

  handlers:
    - name: Reload environment
      shell: |
        source /etc/environment
        source /etc/profile
      changed_when: false

    - name: Update shell environment
      shell: |
        exec $SHELL
      changed_when: false